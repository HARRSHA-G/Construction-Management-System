{% extends 'base.html' %}
{% block title %}Ram Constructions - Expenses{% endblock %}

{% block extra_head %}
<style>
    .expense-form {
        background-color: #1F2937;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .form-input {
        background-color: #374151;
        border: none;
        color: #F3F4F6;
        border-radius: 0.375rem;
        padding: 0.75rem 1rem;
        width: 100%;
    }
    
    .form-input:focus {
        outline: none;
        box-shadow: 0 0 0 2px #3B82F6;
    }
    
    .form-label {
        color: #D1D5DB;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .expense-type-radio {
        display: none;
    }
    
    .expense-type-label {
        display: inline-block;
        padding: 0.5rem 1rem;
        background-color: #374151;
        color: #D1D5DB;
        border-radius: 0.375rem;
        cursor: pointer;
        margin-right: 0.5rem;
    }
    
    .expense-type-radio:checked + .expense-type-label {
        background-color: #3B82F6;
        color: white;
    }
    
    .expense-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .expense-table th {
        background-color: #374151;
        color: #D1D5DB;
        padding: 0.75rem 1rem;
        text-align: left;
    }
    
    .expense-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #374151;
        color: #F3F4F6;
    }
    
    .expense-table tr:hover {
        background-color: #374151;
    }
    
    .btn-primary {
        background-color: #3B82F6;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        font-weight: 500;
        transition: background-color 0.2s;
    }
    
    .btn-primary:hover {
        background-color: #2563EB;
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }

    .modal-content {
        background-color: #1F2937;
        margin: 15% auto;
        padding: 2rem;
        border-radius: 0.5rem;
        width: 80%;
        max-width: 500px;
    }

    .close {
        color: #D1D5DB;
        float: right;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover {
        color: #F3F4F6;
    }

    .expense-tab {
        padding: 0.5rem 1rem;
        color: #D1D5DB;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .expense-tab:hover {
        color: #3B82F6;
    }

    .expense-tab.active {
        color: #3B82F6;
        border-bottom-color: #3B82F6;
    }

    .expense-table-container {
        margin-top: 1rem;
        overflow-x: auto;
    }

    .expense-table-container table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .expense-table-container th {
        background-color: #374151;
        color: #D1D5DB;
        font-weight: 500;
        text-align: left;
        padding: 0.75rem 1rem;
    }

    .expense-table-container td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #374151;
        color: #F3F4F6;
    }

    .expense-table-container tr:hover {
        background-color: #374151;
    }

    .action-button {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }

    .delete-button {
        color: #EF4444;
    }

    .delete-button:hover {
        color: #DC2626;
        background-color: rgba(239, 68, 68, 0.1);
    }

    .expense-type-selector {
        background-color: #1F2937;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .expense-type-button {
        padding: 0.75rem 1.5rem;
        background-color: #374151;
        color: #D1D5DB;
        border-radius: 0.375rem;
        cursor: pointer;
        margin-right: 0.5rem;
        transition: all 0.3s ease;
    }

    .expense-type-button:hover {
        background-color: #4B5563;
    }

    .expense-type-button.active {
        background-color: #3B82F6;
        color: white;
    }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Expense Type Selection -->
    <div class="expense-type-selector">
        <h2 class="text-2xl font-bold text-white mb-4">Select Expense Type</h2>
        <div class="flex space-x-4">
            <button type="button" class="expense-type-button active" data-type="manpower">Manpower Expense</button>
            <button type="button" class="expense-type-button" data-type="material">Material Expense</button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Add Expense Form -->
        <div class="expense-form">
            <h2 class="text-2xl font-bold text-white mb-6">Add New Expense</h2>
            <div id="expenseError" class="mb-4 text-red-500 font-semibold" style="display:none;"></div>
            <form id="expenseForm" class="space-y-6">
                {% csrf_token %}
                
                <!-- Project Selection -->
                <div>
                    <label class="form-label">Project</label>
                    <select id="formProjectSelect" name="project" class="form-input" required>
                        <option value="">Select Project</option>
                    </select>
                </div>
                
                <!-- Date Selection -->
                <div>
                    <label class="form-label">Date</label>
                    <input type="date" name="date" class="form-input" required>
                </div>
                
                <!-- Hidden expense type field -->
                <input type="hidden" name="type" id="expenseType" value="manpower">
                
                <!-- Dynamic Fields -->
                <div id="manpowerFields">
                    <div>
                        <label class="form-label">Labour Work Type</label>
                        <select id="workTypeSelect" name="work_type" class="form-input" required>
                            <option value="">Select Work Type</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Number of People</label>
                        <input type="number" name="number_of_people" class="form-input" required oninput="calculateManpowerTotal()">
                    </div>
                    <div>
                        <label class="form-label">Unit Labour Cost (₹)</label>
                        <input type="number" name="per_person_cost" step="0.01" class="form-input" required oninput="calculateManpowerTotal()">
                    </div>
                    <div>
                        <label class="form-label">Total Amount (₹)</label>
                        <input type="number" name="total_amount" step="0.01" class="form-input" readonly>
                    </div>
                    <div>
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-input" rows="3"></textarea>
                    </div>
                </div>

                <!-- Material Fields -->
                <div id="materialFields" style="display: none;">
                    <div>
                        <label class="form-label">Item</label>
                        <select name="item" id="materialItemSelect" class="form-input" required>
                            <option value="">Select Item</option>
                        </select>
                    </div>
                    <div id="customItemField" style="display: none;">
                        <label class="form-label">Custom Item Name</label>
                        <input type="text" name="custom_item_name" class="form-input">
                    </div>
                    <div>
                        <label class="form-label">Cost per Unit (₹)</label>
                        <input type="number" name="per_unit_cost" step="0.01" class="form-input" required oninput="calculateMaterialTotal()">
                    </div>
                    <div>
                        <label class="form-label">Quantity</label>
                        <input type="number" name="quantity" step="0.01" class="form-input" required oninput="calculateMaterialTotal()">
                    </div>
                    <div>
                        <label class="form-label">Total Amount (₹)</label>
                        <input type="number" name="total_amount" step="0.01" class="form-input" readonly>
                    </div>
                    <div>
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-input" rows="3"></textarea>
                    </div>
                </div>
                
                <button type="submit" class="btn-primary w-full">Add Expense</button>
            </form>
        </div>
        
        <!-- Expenses List -->
        <div class="expense-form">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Expenses</h2>
            </div>

            <!-- Expense Type Tabs -->
            <div class="mb-6">
                <div class="flex space-x-4 border-b border-gray-700">
                    <button class="expense-tab active" data-type="manpower">Manpower Expenses</button>
                    <button class="expense-tab" data-type="material">Material Expenses</button>
                </div>
            </div>

            <!-- Expenses Tables -->
            <div id="manpowerExpenses" class="expense-table-container">
                <table class="min-w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">People</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost/Person</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                        </tr>
                    </thead>
                    <tbody id="manpowerExpensesTableBody"></tbody>
                </table>
            </div>

            <div id="materialExpenses" class="expense-table-container" style="display: none;">
                <table class="min-w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost/Unit</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                        </tr>
                    </thead>
                    <tbody id="materialExpensesTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Download Modal -->
<div id="downloadModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 class="text-2xl font-bold text-white mb-6">Download Expenses</h2>
        <form id="downloadForm" class="space-y-6">
            <div>
                <label class="form-label">Select Project</label>
                <select id="downloadProjectSelect" name="project" class="form-input" required>
                    <option value="">All Projects</option>
                </select>
            </div>
            <div>
                <label class="form-label">Format</label>
                <div class="flex space-x-4">
                    <input type="radio" id="pdfFormat" name="format" value="pdf" class="expense-type-radio" checked>
                    <label for="pdfFormat" class="expense-type-label">PDF</label>
                    
                    <input type="radio" id="excelFormat" name="format" value="excel" class="expense-type-radio">
                    <label for="excelFormat" class="expense-type-label">Excel</label>
                </div>
            </div>
            <button type="submit" class="btn-primary w-full">Download</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Add CSRF token to all AJAX requests
function getCSRFToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Add CSRF token to all fetch requests
function fetchWithCSRF(url, options = {}) {
    const defaultOptions = {
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    };
    return fetch(url, { ...defaultOptions, ...options });
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded');
    initializeProjectSelects();
    initializeWorkTypeSelect();
    initializeExpenseTabs();
    initializeExpenseTypeSelector();
    initializeExpenseForm();
    
    // Load initial expenses
    const activeTab = document.querySelector('.expense-tab.active');
    if (activeTab) {
        fetchExpensesByType(activeTab.dataset.type);
    }
});

function initializeProjectSelects() {
    const formProjectSelect = document.getElementById('formProjectSelect');
    
    // Fetch projects with CSRF
    fetchWithCSRF('/api/projects/')
        .then(response => response.json())
        .then(projects => {
            projects.forEach(project => {
                // Add to form select
                const formOption = document.createElement('option');
                formOption.value = project.id;
                formOption.textContent = project.name;
                formProjectSelect.appendChild(formOption);
            });
        })
        .catch(error => {
            console.error('Error fetching projects:', error);
            alert('Failed to fetch projects. Please try again.');
        });
}

function initializeWorkTypeSelect() {
    const workTypeSelect = document.getElementById('workTypeSelect');
    if (!workTypeSelect) return;
    fetchWithCSRF('/api/labor-work-types/')
        .then(response => response.json())
        .then(workTypes => {
            workTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.name_display || type.name;
                workTypeSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error fetching work types:', error);
            alert('Failed to fetch labor work types.');
        });
}

function handleItemSelection() {
    const itemSelect = document.querySelector('select[name="item"]');
    const customItemField = document.getElementById('customItemField');
    const customItemInput = document.querySelector('input[name="custom_item_name"]');
    
    if (itemSelect.value === 'others') {
        customItemField.style.display = 'block';
        customItemInput.required = true;
    } else {
        customItemField.style.display = 'none';
        customItemInput.required = false;
    }
}

function calculateManpowerTotal() {
    const numberOfPeople = parseFloat(document.querySelector('input[name="number_of_people"]').value) || 0;
    const perPersonCost = parseFloat(document.querySelector('input[name="per_person_cost"]').value) || 0;
    const total = Math.round(numberOfPeople * perPersonCost); // integer only
    const totalInput = document.querySelector('input[name="total_amount"]');
    if (totalInput) {
        totalInput.value = total;
    }
}

function calculateMaterialTotal() {
    const perUnitCost = parseFloat(document.querySelector('input[name="per_unit_cost"]').value) || 0;
    const quantity = parseFloat(document.querySelector('input[name="quantity"]').value) || 0;
    const total = Math.round(perUnitCost * quantity); // integer only
    const totalInput = document.querySelector('#materialFields input[name="total_amount"]');
    if (totalInput) {
        totalInput.value = total;
    }
}

function initializeExpenseTypeSelector() {
    const expenseTypeButtons = document.querySelectorAll('.expense-type-button');
    const expenseTypeInput = document.getElementById('expenseType');
    const materialFields = document.getElementById('materialFields');
    const manpowerFields = document.getElementById('manpowerFields');
    const expenseForm = document.getElementById('expenseForm');

    function setRequiredFields(type) {
        // Manpower fields
        document.querySelector('input[name="number_of_people"]').required = (type === 'manpower');
        document.querySelector('input[name="per_person_cost"]').required = (type === 'manpower');
        // Material fields
        document.querySelector('select[name="item"]').required = (type === 'material');
        document.querySelector('input[name="per_unit_cost"]').required = (type === 'material');
        document.querySelector('input[name="quantity"]').required = (type === 'material');
    }

    expenseTypeButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            expenseTypeButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');

            const expenseType = this.dataset.type;
            expenseTypeInput.value = expenseType;

            // Show/hide appropriate form fields
            if (expenseType === 'material') {
                materialFields.style.display = 'block';
                manpowerFields.style.display = 'none';
                // Reset material fields
                document.querySelector('input[name="per_unit_cost"]').value = '';
                document.querySelector('input[name="quantity"]').value = '';
                document.querySelector('#materialFields input[name="total_amount"]').value = '0';
                document.querySelector('select[name="item"]').value = '';
                document.getElementById('customItemField').style.display = 'none';
                // Fetch material items when switching to material expense
                fetchMaterialItems();
            } else {
                materialFields.style.display = 'none';
                manpowerFields.style.display = 'block';
                // Reset manpower fields
                document.querySelector('input[name="number_of_people"]').value = '';
                document.querySelector('input[name="per_person_cost"]').value = '';
                document.querySelector('input[name="total_amount"]').value = '0';
            }

            // Set required attributes correctly
            setRequiredFields(expenseType);

            // Reset form
            expenseForm.reset();
        });
    });

    // Set required fields on initial load
    setRequiredFields(document.getElementById('expenseType').value);
}

function initializeExpenseForm() {
    const expenseForm = document.getElementById('expenseForm');

    // Add input event listeners for calculations
    document.querySelector('input[name="per_unit_cost"]').addEventListener('input', calculateMaterialTotal);
    document.querySelector('input[name="quantity"]').addEventListener('input', calculateMaterialTotal);
    document.querySelector('input[name="number_of_people"]').addEventListener('input', calculateManpowerTotal);
    document.querySelector('input[name="per_person_cost"]').addEventListener('input', calculateManpowerTotal);

    // Handle form submission with CSRF
    expenseForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const expenseType = document.getElementById('expenseType').value;
        
        // Validate material expense fields
        if (expenseType === 'material') {
            const itemSelect = document.querySelector('select[name="item"]');
            if (itemSelect.value === '') {
                alert('Please select a material item');
                return;
            }
        }

        // Calculate totals before submission
        if (expenseType === 'manpower') {
            calculateManpowerTotal();
        } else if (expenseType === 'material') {
            calculateMaterialTotal();
        }

        // Convert FormData to JSON
        const jsonData = {
            type: expenseType,
            project: formData.get('project'),
            date: formData.get('date'),
            description: formData.get('description') || ''
        };

        // Add type-specific fields
        if (expenseType === 'manpower') {
            jsonData.number_of_people = parseInt(formData.get('number_of_people'));
            jsonData.per_person_cost = parseFloat(formData.get('per_person_cost'));
            jsonData.total_amount = parseFloat(document.querySelector('#manpowerFields input[name="total_amount"]').value);
            jsonData.work_type = formData.get('work_type');
        } else if (expenseType === 'material') {
            jsonData.item = formData.get('item');
            if (jsonData.item === 'others') {
                jsonData.custom_item_name = formData.get('custom_item_name');
            }
            jsonData.per_unit_cost = parseFloat(formData.get('per_unit_cost'));
            jsonData.quantity = parseFloat(formData.get('quantity'));
            jsonData.total_amount = parseFloat(document.querySelector('#materialFields input[name="total_amount"]').value);
        }

        try {
            const response = await fetchWithCSRF('/api/expenses/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to add expense');
            }

            alert('Expense added successfully!');
            this.reset();
            document.getElementById('customItemField').style.display = 'none';
            
            // Refresh the expenses list
            const activeTab = document.querySelector('.expense-tab.active');
            if (activeTab) {
                fetchExpensesByType(activeTab.dataset.type);
            }
        } catch (error) {
            console.error('Error:', error);
            alert(error.message);
        }
    });
}

async function fetchExpensesByType(type) {
    try {
        const response = await fetchWithCSRF(`/api/expenses/?type=${type}`);
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to fetch expenses');
        }
        const expenses = await response.json();
        updateExpenseTable(type, expenses);
    } catch (error) {
        console.error(`Error fetching ${type} expenses:`, error);
        const tbody = document.getElementById(`${type}ExpensesTableBody`);
        tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error: ${error.message}</td></tr>`;
    }
}

async function fetchExpensesByProject(projectId) {
    try {
        const response = await fetchWithCSRF(`/api/expenses/?project_id=${projectId}`);
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to fetch project expenses');
        }
        const expenses = await response.json();
        
        // Group expenses by type
        const groupedExpenses = {
            manpower: expenses.filter(e => e.type === 'manpower'),
            material: expenses.filter(e => e.type === 'material')
        };
        
        // Update each table
        Object.entries(groupedExpenses).forEach(([type, typeExpenses]) => {
            updateExpenseTable(type, typeExpenses);
        });
    } catch (error) {
        console.error('Error fetching project expenses:', error);
        const tables = ['manpower', 'material'];
        tables.forEach(type => {
            const tbody = document.getElementById(`${type}ExpensesTableBody`);
            tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error: ${error.message}</td></tr>`;
        });
    }
}

function updateExpenseTable(type, expenses) {
    const tbody = document.getElementById(`${type}ExpensesTableBody`);
    tbody.innerHTML = '';
    
    if (!expenses || expenses.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="6" class="px-6 py-4 text-center text-gray-500">No expenses found</td>`;
        tbody.appendChild(row);
        return;
    }
    
    expenses.forEach(expense => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-700 transition-colors duration-200';
        
        switch(type) {
            case 'manpower':
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${expense.project_name || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${new Date(expense.date).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${expense.number_of_people}</td>
                    <td class="px-6 py-4 whitespace-nowrap">₹${parseFloat(expense.per_person_cost).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">₹${parseFloat(expense.total_amount).toFixed(2)}</td>
                `;
                break;
                
            case 'material':
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${expense.project_name || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${new Date(expense.date).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${expense.custom_item_name || expense.item_display || expense.item}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${expense.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap">₹${parseFloat(expense.per_unit_cost).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">₹${parseFloat(expense.total_amount).toFixed(2)}</td>
                `;
                break;
        }
        
        tbody.appendChild(row);
    });
}

async function deleteExpense(id, type) {
    if (!confirm('Are you sure you want to delete this expense?')) return;
    
    try {
        const response = await fetchWithCSRF(`/api/expenses/${id}/?type=${type}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to delete expense');
        }

        // Refresh the current view
        const projectId = document.getElementById('formProjectSelect').value;
        if (projectId) {
            fetchExpensesByProject(projectId);
        } else {
            const activeTab = document.querySelector('.expense-tab.active');
            if (activeTab) {
                fetchExpensesByType(activeTab.dataset.type);
            }
        }
    } catch (error) {
        console.error('Error deleting expense:', error);
        alert(`Failed to delete expense: ${error.message}`);
    }
}

function initializeExpenseTabs() {
    const tabs = document.querySelectorAll('.expense-tab');
    const tables = document.querySelectorAll('.expense-table-container');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Remove active class from all tabs
            tabs.forEach(t => t.classList.remove('active'));
            // Add active class to clicked tab
            this.classList.add('active');
            
            // Hide all tables
            tables.forEach(table => table.style.display = 'none');
            
            // Show the corresponding table
            const type = this.dataset.type;
            document.getElementById(`${type}Expenses`).style.display = 'block';
            
            // Fetch expenses for the selected type
            fetchExpensesByType(type);
        });
    });
}

function showExpenseError(message) {
    const errorDiv = document.getElementById('expenseError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
}

// Add this function to fetch material items
async function fetchMaterialItems() {
    try {
        const response = await fetchWithCSRF('/api/material-items/');
        if (!response.ok) {
            throw new Error('Failed to fetch material items');
        }
        const items = await response.json();
        const itemSelect = document.getElementById('materialItemSelect');
        itemSelect.innerHTML = '<option value="">Select Item</option>';
        items.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = item.display_name;
            itemSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error fetching material items:', error);
        alert('Failed to load material items. Please try again.');
    }
}
</script>
{% endblock %}