<script>
    // Fetch CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // Fetch material items
    async function fetchMaterialItems() {
        try {
            const response = await fetch('/api/material-items/');
            if (!response.ok) {
                throw new Error('Failed to fetch material items');
            }
            const items = await response.json();
            const itemSelect = document.getElementById('materialItem');
            itemSelect.innerHTML = '<option value="">Select Material Item</option>';
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.display_name;
                itemSelect.appendChild(option);
            });
            // Add "Others" option
            const othersOption = document.createElement('option');
            othersOption.value = 'others';
            othersOption.textContent = 'Others';
            itemSelect.appendChild(othersOption);
        } catch (error) {
            console.error('Error fetching material items:', error);
            alert('Failed to load material items. Please try again.');
        }
    }

    // Initialize material items on page load
    document.addEventListener('DOMContentLoaded', function() {
        fetchMaterialItems();
    });

    // Handle material item selection
    document.getElementById('materialItem').addEventListener('change', function() {
        const customItemDiv = document.getElementById('customItemDiv');
        if (this.value === 'others') {
            customItemDiv.style.display = 'block';
        } else {
            customItemDiv.style.display = 'none';
        }
    });

    // Handle form submission
    document.getElementById('expenseForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const expenseType = formData.get('expenseType');
        
        try {
            const response = await fetch('/api/expenses/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(Object.fromEntries(formData))
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to add expense');
            }

            alert('Expense added successfully!');
            this.reset();
            document.getElementById('customItemDiv').style.display = 'none';
            // Refresh the expenses list
            loadExpenses();
        } catch (error) {
            console.error('Error:', error);
            alert(error.message);
        }
    });

    // Load expenses
    async function loadExpenses() {
        const expenseType = document.getElementById('expenseType').value;
        const projectId = document.getElementById('project').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const search = document.getElementById('search').value;

        try {
            const response = await fetch(`/api/expenses/?type=${expenseType}&project_id=${projectId}&start_date=${startDate}&end_date=${endDate}&search=${search}`);
            if (!response.ok) {
                throw new Error('Failed to fetch expenses');
            }
            const expenses = await response.json();
            displayExpenses(expenses);
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to load expenses. Please try again.');
        }
    }

    // Display expenses in the table
    function displayExpenses(expenses) {
        const tbody = document.querySelector('#expensesTable tbody');
        tbody.innerHTML = '';
        
        expenses.forEach(expense => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${expense.date}</td>
                <td>${expense.project_name}</td>
                <td>${expense.description || ''}</td>
                <td>${expense.amount}</td>
                <td>
                    <button onclick="deleteExpense(${expense.id})" class="btn btn-danger btn-sm">Delete</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    // Delete expense
    async function deleteExpense(id) {
        if (!confirm('Are you sure you want to delete this expense?')) {
            return;
        }

        try {
            const response = await fetch(`/api/expenses/${id}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrftoken
                }
            });

            if (!response.ok) {
                throw new Error('Failed to delete expense');
            }

            alert('Expense deleted successfully!');
            loadExpenses();
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to delete expense. Please try again.');
        }
    }

    // Initialize expenses on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadExpenses();
    });
</script> 